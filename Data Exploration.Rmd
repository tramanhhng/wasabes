---
title: "Indoor Positioning Data Exploration"
author: "STAT4/510 Wasabees Group"
date: "2023-11-30"
output: pdf_document
---

1. Describe your data
2. Describe the basic variable component of your data
3. Report the various findings you have established so far, with interprtation (include discussion on what you find and add how useful it is to your project objective)
4. Discuss any challenges you encountered, and ways by which you handled these.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
```

# Introduction

Indoor position systems (IPS) development is an active area of research that can be used in numerous settings. Part of efforts to develop, calibration and model these systems are achieved throught the use of WIFI signals. The following report, describes and characterizes a large data set compiled in a 15 by 36 meter area that contains six (wifi routers) access points, signal strength, various locations and orientation of the devices.
The data is subdivided in two sub-sets, one denominated "offline data", which corresponds to various testing devices connected to the network at different locations and orientations, and an "online data", where 60 locations and orientations of the devices were selected at random.

The offline data was collected designing a 1 meter resolution grid, resulting in 166 locations. In each of these locations, the device was oriented starting at 0 degrees inclination and at 45 degrees increments, and the strength signal measured. Furthermore, each combination of location/orientation was sampled 110 times. This grid sampling is intended to be used to calibrate a indoor positioning model. On the other hand, the online data was designed to simulate real-world data, in which locations are not bounded by the 1 meter grid used in the offline data, and were selected at random. This randomization included the orientation of the device and therefore, the online data consists of 60 randomly selected location/orientation combinations sampled 110 times. 

More details of the floorplan, and location of online and offline data can be seen in Figure 1.

![Figure 1: Flooplan location. Access points are squares. Grey dots are offline data locations and black dots are online data locations.](data/floorplan.jpg)
Noting that the online and offline data sets share the same structure, in this document, we explore the offline data set with the expectation to apply the same method for the online data set.


# Transferring text data into a data frame

Our offline data set was handed to us as a .txt file with the following structure:

```{r read_offline_data}

#Read the offline data txt file, with each row in the txt file becoming a text string

raw_offline = readLines("Data/offline.final.trace.txt")
str(raw_offline) 
head(raw_offline)
```

The raw data contains multiple rows starting with # (for example: rows 1, 2, 3) that provide generic information. The actual data are contained in other rows with variables separated by semicolons (for example, row 4). Our next step was to clean all rows that start with the character #. `r length(raw_offline) - length(clean_offline)` rows were removed, resulting in `r length(clean_offline)` rows in our clean data set.

```{r clean_#_rows}

# The code below removes all rows that start with #

clean_offline <- raw_offline[substr(raw_offline,start=1, stop=1) != "#"]
head(clean_offline)

```

The clean data set contains the following variables:
*`time`: time in miliseconds
*`scanMac`: IP address of the scanning device
*`pos`: the 3-D coordination of the scanning device
*`orientation`: the scanning device's orientation
*`mac`: the IP address of the access points
*`signal`: signal strength in dBm
*`channel`: the channel frequency
*`type`: type of device (access point = 3, device in adhoc mode =1)  

Each row in the clean data set contains all of those variables in the following structure:   
*For the variables `time`, `id`, `pos`, `orientation`: semicolons separate between variables, equal signs separate variable names and values
*The other variables follow this structure: `mac` = `signal`, `channel`, `type`

Understanding this data structure, our next task is to separate these variables and put them in a data frame that will allow analysis later. We first tried to it with one line - line [1].

```{r split_one_line}
#The code below took all the separation out of one line. We take line 1 as an example and our separators are ; , and =
line = strsplit(clean_offline[1], "[; , =]") [[1]]
line

#The code below takes the time, id, pos, and degree readings out of "line" and arrange them in a matrix
a = line[c(2,4,6,7,8,10)] %>% 
  matrix(ncol=6,byrow=TRUE)
a

#The code below takes the mac, signal, channel, and device type reading out of "line" and arrange them in a matrix
b= line[-(1:10)] %>%
  matrix(ncol=4, byrow=TRUE)
b

#After this, we can combine the two matrices into a data frame. Our unit of analysis is signal strength, which mean each signal strength value needs to be one single observation. So to combine the data, we need to duplicate `a` by the number of rows in `b`.

a = line[c(2,4,6,7,8,10)] %>% 
  matrix(ncol=6,nrow=nrow(b), byrow=TRUE)

cbind(a,b) %>% view()
```

Now that we have successfully separated the variables in line [1], we combined all operations above into a `clean_function` that can be applied to all rows.
```{r split_each_line}

#The code below attempts to put all the above operations in this code chunk in one function
clean_function = function(x) {
  line = strsplit(x, "[; , =]") [[1]]
  b = line[-(1:10)] %>% matrix(ncol=4, byrow=TRUE)  
  a = line[c(2,4,6,7,8,10)] %>% matrix(ncol=6, nrow=nrow(b), byrow=TRUE) 
  cbind(a,b)
}

#Test clean_function with row 1 in clean_offline
line_1 <- lapply(clean_offline[1], clean_function) [[1]]
line_1
```

Our next task was to run the `clean_function` on all rows in our clean data set and bind them all together into a big data frame.
```{r bind_all_lines}
#Set up line_1 as the base for the offline_data frame
offline_df <- as.data.frame(line_1)
view(offline_df)

#Run a loop so that the next line gets added to offline_df
for(i in 2:length(clean_offline)) {
  line_i <- lapply(clean_offline[i], clean_function) [[1]]
  offline_df <- rbind(offline_df,line_i)
}


```

# Data cleaning
Name the variables.

```{r}
names(clean_offline) = c("time", "scanMac", "posX", "posY", "posZ", "orientation", "mac", "signal", "channel", "type")
```
We need to convert some variables to numeric.

```{r}
numeric_var = c("time","posX","posY","posZ","orientation","signal")
clean_offline[numeric_var] = lapply(clean_offline[numeric_var],as.numeric)
```

```{r}
OffLine = clean_offline[clean_offline$type == "3", ]
OffLine = clean_offline[, "type" != names(clean_offline)]
```

```{r}
offline$rawtime = OffLine$time
offline$time = OffLine$time/1000
class(offline$time) = c("POSIXt","POSIXct")
```

# Data exploration
```{r}
# Plot the orientation of the measurement device
plot(ecdf(OffLine$orientation))
```
